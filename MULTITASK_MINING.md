# Multi-Task Data Mining

This document describes the multi-task example mining system for iBERT.

## Overview

**Location**: [src/datagen/mining/multitask_miner.py](src/datagen/mining/multitask_miner.py)

The mining system automatically extracts training examples for all 6 iBERT tasks from the Ibis codebase:
1. Code Completion
2. SQL→Ibis Translation
3. Ibis→SQL Translation
4. Error Resolution
5. Q&A
6. Function Documentation

## Mining Strategies

### 1. Code Completion (104 examples mined)

**Strategy**: Extract method chains and create partial/completion pairs

**Pattern**:
- Find chained Ibis expressions (e.g., `table.filter(...).group_by(...).aggregate(...)`)
- Extract prefixes as partial code
- Full expression becomes the completion target

**Example**:
```json
{
    "task": "code_completion",
    "source": "ibis_codebase",
    "input": {
        "partial_code": "t.select([t[c] for c in t.columns if t[c].type("
    },
    "target": {
        "completed_code": "t.select([t[c] for c in t.columns if t[c].type().is_numeric()"
    }
}
```

**Quality**: High - Real-world Ibis code patterns from production codebase

### 2. SQL→Ibis Translation (15 examples mined)

**Strategy**: Extract SQL from `.sql()` calls and code strings

**Patterns Matched**:
- `.sql("SELECT ...")`
- `.sql("""SELECT ...""")`
- `sql = "SELECT ..."`

**Example**:
```json
{
    "task": "sql_to_ibis",
    "source": "ibis_codebase",
    "input": {
        "sql": "SELECT * FROM table WHERE age > 18"
    },
    "target": {
        "ibis": "# Mined example - Ibis equivalent to be inferred"
    }
}
```

**Note**: Ibis equivalents need manual review or automated generation

**Quality**: Medium - SQL is accurate, Ibis code needs generation

### 3. Ibis→SQL Translation (95 examples mined)

**Strategy**: Extract Ibis expressions and generate SQL via compiler

**Patterns Matched**:
- `table.filter(...)`
- `table.select(...)`
- `table.group_by(...)`
- `table.aggregate(...)`

**Example**:
```json
{
    "task": "ibis_to_sql",
    "source": "ibis_codebase",
    "input": {
        "ibis": "table.filter(table.age > 18)",
        "dialect": "duckdb"
    },
    "target": {
        "sql": "# SQL to be generated by Ibis compiler"
    }
}
```

**Note**: SQL can be generated using Ibis's built-in compiler

**Quality**: High - Real Ibis expressions, SQL easily generated

### 4. Error Resolution (0 examples mined)

**Strategy**: Mine git history for fix commits

**Approach**:
- Search for commits with keywords: "fix", "error", "bug"
- Extract before/after code diffs
- Parse commit messages for error descriptions

**Current Status**:
- Only 1 relevant commit found in recent history
- Pattern extraction needs refinement
- **Recommendation**: Use manual template-based examples instead

**Quality**: Low - Insufficient git history patterns

### 5. Q&A (0 examples mined)

**Strategy**: Extract from documentation FAQs and "How to" sections

**Patterns Searched**:
- FAQ sections in markdown
- "How do I..." / "How to..." headings
- Q&A format in docs

**Current Status**:
- No FAQ sections found in current doc structure
- **Recommendation**: Mine from GitHub issues, Stack Overflow, or Discord

**Quality**: N/A - No examples found

### 6. Function Documentation (200 examples mined)

**Strategy**: Extract functions with docstrings from source code

**Approach**:
- Parse Python AST for function definitions
- Extract function signatures
- Capture associated docstrings
- Detect docstring style (Google vs NumPy)

**Example**:
```json
{
    "task": "documentation",
    "source": "ibis_codebase",
    "input": {
        "code": "def data_dir() -> Path:",
        "style": "numpy"
    },
    "target": {
        "docstring": "\"\"\"Return the test data directory.\n\nReturns\n-------\nPath\n    Test data directory\"\"\""
    }
}
```

**Quality**: Excellent - Real docstrings from Ibis codebase

## Mining Results Summary

| Task | Examples Mined | Quality | Notes |
|------|---------------|---------|-------|
| **Code Completion** | 104 | ⭐⭐⭐⭐⭐ | Real method chains from codebase |
| **SQL→Ibis** | 15 | ⭐⭐⭐ | SQL accurate, Ibis needs generation |
| **Ibis→SQL** | 95 | ⭐⭐⭐⭐ | Ibis accurate, SQL easily generated |
| **Error Resolution** | 0 | ⭐ | Insufficient git patterns |
| **Q&A** | 0 | N/A | No FAQ sections found |
| **Documentation** | 200 | ⭐⭐⭐⭐⭐ | Production-quality docstrings |
| **TOTAL** | **414** | | |

## Usage

### Mine all tasks:
```bash
just mine-multitask
```

Or directly:
```bash
PYTHONPATH=. .venv/bin/python src/datagen/mining/multitask_miner.py
```

### Mine specific task:
```bash
just mine-task documentation
```

Or directly:
```bash
PYTHONPATH=. .venv/bin/python src/datagen/mining/multitask_miner.py --task documentation
```

### Available tasks:
- `code_completion`
- `sql_to_ibis`
- `ibis_to_sql`
- `error_resolution`
- `qa`
- `documentation`

## Output Location

Mined examples are saved to: `data/mining/multitask/`

Files:
- `code_completion_mined.jsonl`
- `sql_to_ibis_mined.jsonl`
- `ibis_to_sql_mined.jsonl`
- `error_resolution_mined.jsonl`
- `qa_mined.jsonl`
- `documentation_mined.jsonl`

## Integration with Data Pipeline

The concatenation script ([src/datagen/concatenate_datasets.py](src/datagen/concatenate_datasets.py)) automatically includes mined multitask data in the final training dataset.

Run:
```bash
just concatenate-data
```

This combines:
- Template-generated examples
- Mined multitask examples
- Other mined data sources

Into: `data/train_complete.jsonl`

## Recommendations for Improvement

### High Priority

1. **Q&A Mining**:
   - Mine GitHub issues with "question" label
   - Extract Stack Overflow questions tagged "ibis"
   - Parse Discord/community forum discussions
   - Use GitHub Discussions API

2. **Error Resolution Mining**:
   - Increase git history depth (currently only recent commits)
   - Mine from test files showing error cases
   - Extract from issue trackers linking to fixing commits
   - Parse error messages from test suites

### Medium Priority

3. **SQL→Ibis Enhancement**:
   - Auto-generate Ibis equivalents using pattern matching
   - Use Ibis's SQL decompiler to create Ibis code
   - Validate SQL→Ibis pairs before including

4. **Ibis→SQL Enhancement**:
   - Use Ibis compiler to generate SQL automatically
   - Test with multiple SQL dialects
   - Validate SQL output executes correctly

### Low Priority

5. **Code Completion Enhancement**:
   - Extract from Jupyter notebooks
   - Mine from example galleries
   - Include incomplete expressions from comments

6. **Documentation Enhancement**:
   - Include class docstrings
   - Extract module-level documentation
   - Mine parameter descriptions separately

## Example Quality Checks

All mined examples can be validated using the multitask validator:

```bash
just validate-multitask
```

This ensures:
- Code is syntactically valid
- Examples follow expected format
- Semantic correctness (where applicable)

See [VALIDATION_RESULTS.md](VALIDATION_RESULTS.md) for validation details.

## Future Enhancements

1. **Web Scraping**: Mine from Ibis documentation website
2. **Community Data**: Extract from user forums and chat logs
3. **Notebook Mining**: Process Jupyter notebooks in examples/
4. **Test Suite Mining**: Extract test cases as training examples
5. **API Usage Mining**: Analyze real-world Ibis usage from public repos
